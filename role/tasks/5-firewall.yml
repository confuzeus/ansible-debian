---
- name: Accept all incoming traffic temporarily
  iptables:
    chain: INPUT
    protocol: tcp
    jump: ACCEPT

- name: Accept all outgoing traffic temporarily
  iptables:
    chain: OUTPUT
    protocol: tcp
    jump: ACCEPT

- name: Set incoming policy to accept temporarily
  iptables:
    chain: INPUT
    policy: ACCEPT

- name: Flush iptables
  iptables:
    flush: yes

- name: Allow incoming ssh
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ sshd_port_number }}"
    jump: ACCEPT

- name: Allow all outgoing traffic
  iptables:
    chain: OUTPUT
    jump: ACCEPT

- name: Drop all forwarding traffic
  iptables:
    chain: FORWARD
    policy: DROP

- name: Drop all incoming traffic
  iptables:
    chain: INPUT
    policy: DROP

- name: Allow related and established connections
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT

- name: Allow loopback interface
  iptables:
    chain: INPUT
    in_interface: "lo"
    jump: ACCEPT

- name: Drop invalid packets
  iptables:
    chain: INPUT
    ctstate: INVALID
    jump: DROP
  
- name: Allow icmp
  iptables:
    chain: INPUT
    ctstate: NEW
    protocol: icmp
    icmp_type: "8"
    jump: ACCEPT

- name: Reject UDP with ICMP port unreachable
  iptables:
    chain: INPUT
    protocol: udp
    reject_with: "icmp-port-unreachable"

- name: Reject TCP with TCP RESET
  iptables:
    chain: INPUT
    protocol: tcp
    reject_with: "tcp-reset"

- name: Reject all other protocols with icmp-proto-unreachable
  iptables:
    chain: INPUT
    protocol: all
    reject_with: "icmp-proto-unreachable"

- name: Allow tcp ports
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ item }}"
    jump: ACCEPT
  with_items: ["80", "443"]

- name: Save iptables rules
  shell: "/sbin/iptables-save > /etc/iptables.up.rules"

- name: Make iptables rules persistent
  copy:
    src: "iptables-persistent"
    dest: "/etc/network/if-pre-up.d/iptables"
    mode: "u+x"